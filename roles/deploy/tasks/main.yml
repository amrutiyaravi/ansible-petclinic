- name: Get running processes
  shell: "ps -ef | grep -v grep | grep -w {{ APP_NAME }} | awk '{print $2}'"
  register: running_processes

- name: Kill running processes
  shell: "kill {{ item }}"
  with_items: "{{ running_processes.stdout_lines }}"

- wait_for:
    path: "/proc/{{ item }}/status"
    state: absent
  with_items: "{{ running_processes.stdout_lines }}"
  ignore_errors: yes
  register: killed_processes

- name: Force kill stuck processes
  shell: "kill -9 {{ item }}"
  with_items: "{{ killed_processes.results | select('failed') | map(attribute='item') | list }}"

- name: Creates petclinic directory
  file:
    path: "{{ item }}"
    state: directory
    owner: devops
    group: devops
    mode: u=rwx,g=r,o=r
  with_items:
    - "{{ DEPLOY_PATH }}"
    - "{{ LOG_PATH }}"

- name: Copy petclinic JAR to tomcat
  copy:
    src: "{{ BUILD_PATH }}/target/spring-petclinic-2.1.0.BUILD-SNAPSHOT.jar"
    dest: "{{ DEPLOY_PATH }}"
    owner: devops
    group: devops
    mode: u=rw,g=r,o=r

- name: Set BUILD_ID to dotnKillMe
  shell: export BUILD_ID=dontKillMe

- name: Start PetClinic 
  shell: nohup java -jar spring-petclinic-2.1.0.BUILD-SNAPSHOT.jar --spring.profiles.active=mysql >> {{ LOG_PATH }}/petclinic.log 2>&1 &
  args:
    chdir: "{{ DEPLOY_PATH }}"
  register: start_result

- name: Start result output
  debug:
    var: start_result
